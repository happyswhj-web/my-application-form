<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>직원 근태 관리 시스템 (구글 시트 연동)</title>
    <style>
        body { font-family: 'Malgun Gothic', '맑은 고딕', sans-serif; margin: 0; padding: 20px; background-color: #f4f7f6; color: #333; }
        .container { max-width: 1000px; margin: 20px auto; padding: 20px; background-color: #fff; border-radius: 8px; box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1); }
        h1 { text-align: center; color: #2c3e50; }
        .form-container { display: flex; flex-wrap: wrap; gap: 15px; margin-bottom: 25px; padding: 20px; border: 1px solid #ddd; border-radius: 8px; background-color: #fafafa; align-items: center; }
        .form-container input, .form-container select { padding: 10px; border: 1px solid #ccc; border-radius: 4px; font-size: 16px; flex-grow: 1; }
        .form-container input[type="text"][placeholder="비고"] { min-width: 200px; }
        .form-container button { padding: 10px 20px; border: none; border-radius: 4px; background-color: #3498db; color: white; font-size: 16px; cursor: pointer; transition: background-color 0.3s; }
        .form-container button:hover { background-color: #2980b9; }

        /* 출퇴근 토글 버튼 스타일 */
        #toggleButton {
            background-color: #2ecc71; /* 출근 상태 */
        }
        #toggleButton.clock-out {
            background-color: #e74c3c; /* 퇴근 상태 */
        }
        #toggleButton:hover {
            background-color: #27ae60;
        }
        #toggleButton.clock-out:hover {
            background-color: #c0392b;
        }
        
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { border: 1px solid #ddd; padding: 12px; text-align: center; }
        thead { background-color: #ecf0f1; }
        th { font-weight: bold; color: #34495e; }
        tbody tr:nth-child(even) { background-color: #f9f9f9; }

        /* 메시지 창 스타일 */
        .message-box {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            display: none;
            text-align: center;
        }

        .message-box.success {
            background-color: #4CAF50;
            color: white;
        }

        .message-box.error {
            background-color: #f44336;
            color: white;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>직원 근태 관리 시스템</h1>
        <div class="form-container">
            <select id="name" onchange="updateButtonState()" required>
                <option value="" disabled selected>이름 선택</option>
                <option value="오철수">오철수</option>
                <option value="김철수">문보은</option>
                <option value="박경혜">박경혜</option>
                <option value="엄은희">엄은희</option>
                <option value="이영희">이영희</option>
            </select>
            <input type="date" id="date">
            
            <button id="toggleButton" onclick="toggleAttendance()" disabled>출근하기</button>

            <input type="text" id="notes" placeholder="비고">
            </div>
        <table id="attendanceTable">
            <thead>
                <tr>
                    <th>이름</th>
                    <th>날짜</th>
                    <th>출근시간</th>
                    <th>퇴근시간</th>
                    <th>비고</th>
                </tr>
            </thead>
            <tbody id="attendanceBody">
                </tbody>
        </table>
    </div>
    
    <div id="messageBox" class="message-box"></div>

    <script>
        // 직원별 출근 시간을 저장하는 객체
        const attendanceData = {};
        const scriptURL = 'https://script.google.com/macros/s/AKfycbyUXxV3u9cTQEeqbwYrA8pah3NAGCLo9Wj-choePUzgJoglD51LDTgWz6NG4qbpz3rOiw/exec';

        function showMessage(message, type) {
            const messageBox = document.getElementById('messageBox');
            messageBox.textContent = message;
            messageBox.className = 'message-box ' + type;
            messageBox.style.display = 'block';
            setTimeout(() => {
                messageBox.style.display = 'none';
            }, 3000);
        }

        window.onload = function() {
            const today = new Date();
            const dateString = today.toISOString().split('T')[0];
            document.getElementById('date').value = dateString;
        };

        // 이름 선택 시 버튼 상태를 업데이트하는 함수
        function updateButtonState() {
            const name = document.getElementById('name').value;
            const toggleButton = document.getElementById('toggleButton');

            if (name.trim() === '') {
                toggleButton.textContent = '출근하기';
                toggleButton.disabled = true;
                toggleButton.classList.remove('clock-out');
            } else {
                toggleButton.disabled = false;
                if (attendanceData[name]) {
                    toggleButton.textContent = '퇴근하기';
                    toggleButton.classList.add('clock-out');
                } else {
                    toggleButton.textContent = '출근하기';
                    toggleButton.classList.remove('clock-out');
                }
            }
        }

        // 출근/퇴근 상태를 토글하고 데이터를 저장하는 함수
        async function toggleAttendance() {
            const name = document.getElementById('name').value;
            const date = document.getElementById('date').value;
            const notes = document.getElementById('notes').value;
            const toggleButton = document.getElementById('toggleButton');

            if (name.trim() === '') {
                showMessage('이름을 먼저 선택해주세요.', 'error');
                return;
            }

            const now = new Date();
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            const currentTime = `${hours}:${minutes}`;

            // 출근 상태인 경우 (출근 기록)
            if (!attendanceData[name]) {
                attendanceData[name] = currentTime;
                toggleButton.textContent = '퇴근하기';
                toggleButton.classList.add('clock-out');
                showMessage(`${name}님, 출근 시간이 기록되었습니다: ${currentTime}`, 'success');
            } else {
                // 퇴근 상태인 경우 (데이터 전송)
                const clockIn = attendanceData[name];
                const clockOut = currentTime;
                
                toggleButton.disabled = true;
                toggleButton.textContent = '저장 중...';

                const params = new URLSearchParams({ name, date, clockIn, clockOut, notes });

                try {
                    const response = await fetch(`${scriptURL}?${params.toString()}`);
                    const result = await response.text();

                    if (result === 'Success') {
                        // 성공적으로 전송되면 화면의 테이블에도 행 추가
                        const tableBody = document.getElementById('attendanceBody');
                        const newRow = tableBody.insertRow();
                        newRow.insertCell(0).innerHTML = name;
                        newRow.insertCell(1).innerHTML = date;
                        newRow.insertCell(2).innerHTML = clockIn;
                        newRow.insertCell(3).innerHTML = clockOut;
                        newRow.insertCell(4).innerHTML = notes || '-';
                        
                        showMessage('데이터가 구글 시트에 성공적으로 저장되었습니다.', 'success');
                        
                        // 해당 직원의 상태 초기화
                        delete attendanceData[name];
                    } else {
                        showMessage('저장에 실패했습니다. 다시 시도해주세요.', 'error');
                        console.error('Apps Script Error:', result);
                    }
                } catch (error) {
                    console.error('Error!', error.message);
                    showMessage('저장에 실패했습니다. 다시 시도해주세요.', 'error');
                } finally {
                    toggleButton.disabled = false;
                    updateButtonState(); // 버튼 상태 다시 업데이트
                    document.getElementById('notes').value = '';
                    document.getElementById('name').focus();
                }
            }
        }
    </script>
</body>
</html>